<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Agora Ban API Tester</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="modern-ui-library.css">
        <style>
            body {
                overflow-y: auto;
                background: linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a) !important;
            }
        </style>
    </head>
    <body class="text-white min-h-screen">
        <!-- Popup notification section -->
        <div id="popup-section" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50"></div>
        
        <div class="max-w-6xl mx-auto">
            <!-- API Credentials Button moved outside -->
            <button
                onclick="toggleAuthPopup()"
                class="mb-6 modern-btn modern-btn-secondary"
            >
                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                Set API Credentials
            </button>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Original Ban Management Panel -->
                <div class="modern-card">
                    <h1 class="text-xl font-bold mb-4 text-center gradient-text-primary">
                        Agora Ban User Privilege API Tester
                    </h1>

                    <div class="space-y-4">
                        <!-- <input
                            id="appid"
                            class="w-full p-2 rounded bg-gray-700 text-white"
                            placeholder="App ID"
                        /> -->
                        <input
                            id="cname"
                            type="text"
                            placeholder="Channel Name"
                        />
                        <input
                            id="uid"
                            type="text"
                            placeholder="UID"
                        />
                        <input
                            id="ruleId"
                            type="text"
                            placeholder="Rule ID (Auto-filled)"
                        />
                        <input
                            id="ip"
                            type="text"
                            placeholder="IP (Optional)"
                        />
                        <input
                            id="expireTime"
                            type="number"
                            placeholder="Expiration Time (Seconds)"
                        />
                        <div>
                            <label>Privileges:</label>
                            <select id="privileges">
                                <option value="join_channel">
                                    Join Channel
                                </option>
                                <option value="publish_audio">
                                    Publish Audio
                                </option>
                                <option value="publish_video">
                                    Publish Video
                                </option>
                                <option value="publish_audio_video">
                                    Publish Audio & Video
                                </option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button
                                onclick="sendRequest('POST', 'kicking-rule')"
                                class="modern-btn modern-btn-success"
                            >
                                Create Rules
                            </button>
                            <button
                                onclick="sendRequest('GET', 'kicking-rule')"
                                class="modern-btn modern-btn-primary"
                            >
                                Get Rules
                            </button>
                            <button
                                onclick="sendRequest('PUT', 'kicking-rule')"
                                class="modern-btn modern-btn-warning"
                            >
                                Update Expiration
                            </button>
                            <button
                                onclick="sendRequest('DELETE', 'kicking-rule')"
                                class="modern-btn modern-btn-danger"
                            >
                                Delete Rules
                            </button>
                        </div>
                    </div>
                    <pre id="response" class="mt-4"></pre>
                </div>

                <!-- New User Query Panel -->
                <div class="modern-card">
                    <h1 class="text-xl font-bold mb-4 text-center gradient-text-primary">
                        Query Channel Users
                    </h1>

                    <div class="space-y-4">
                        <input
                            id="queryChannel"
                            type="text"
                            placeholder="Channel Name"
                        />

                        <div class="flex items-center space-x-2">
                            <input
                                type="checkbox"
                                id="hostOnly"
                            />
                            <label for="hostOnly" class="mb-0">Host Only</label>
                        </div>

                        <button
                            onclick="queryUsers()"
                            class="w-full modern-btn modern-btn-primary"
                        >
                            Query Users
                        </button>

                        <pre id="queryResponse" class="mt-4 min-h-[200px]"></pre>
                    </div>
                </div>
            </div>

            <!-- Auth Popup -->
            <div
                id="authPopup"
                class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50"
            >
                <div class="modern-card w-full max-w-sm">
                    <div class="flex items-center gap-3 mb-4 pb-4 border-b border-slate-700/50">
                        <div class="icon-container">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold gradient-text-primary">
                            RESTful API Credentials
                        </h2>
                    </div>
                    <p class="text-sm mb-4 text-slate-400">
                        Enter your Agora Customer ID and Secret for
                        authentication.
                    </p>
                    <div class="space-y-4">
                        <input
                            id="customerId"
                            type="text"
                            placeholder="Customer ID"
                        />
                        <input
                            id="customerSecret"
                            type="password"
                            placeholder="Customer Secret"
                        />
                        <input
                            id="appid"
                            type="text"
                            placeholder="App ID"
                        />
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button
                            onclick="toggleAuthPopup()"
                            class="modern-btn modern-btn-secondary"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Popup notification system
            var popups = 0;
            function showPopup(message) {
                const newPopup = popups + 1;
                const y = document.createElement('div');
                y.id = `popup-${newPopup}`;
                y.className = "popupHidden";
                y.textContent = message;
                document.getElementById("popup-section").appendChild(y);
                const x = document.getElementById(`popup-${newPopup}`);
                x.className = "popupShow";
                const z = popups * 10;
                x.style.left = `${50 + z}%`;
                popups++;
                setTimeout(function() {
                    const popup = document.getElementById(`popup-${newPopup}`);
                    if (popup) {
                        popup.remove();
                        popups--;
                    }
                }, 3000);
            }

            let customerId = localStorage.getItem("customerId");
            let customerSecret = localStorage.getItem("customerSecret");
            let appid = localStorage.getItem("appid");

            function toggleAuthPopup() {
                // Populate fields if already set
                if (customerId) {
                    document.getElementById("customerId").value = customerId;
                }
                if (customerSecret) {
                    document.getElementById("customerSecret").value =
                        customerSecret;
                }
                if (appid) {
                    document.getElementById("appid").value = appid;
                }

                document.getElementById("authPopup").classList.toggle("hidden");
                localStorage.setItem(
                    "customerId",
                    document.getElementById("customerId").value,
                );
                localStorage.setItem(
                    "customerSecret",
                    document.getElementById("customerSecret").value,
                );
                localStorage.setItem(
                    "appid",
                    document.getElementById("appid").value,
                );

                customerId = document.getElementById("customerId").value;
                customerSecret =
                    document.getElementById("customerSecret").value;
                appid = document.getElementById("appid").value;
            }

            async function sendRequest(method, action) {
                const cname = document.getElementById("cname").value;
                const uid = document.getElementById("uid").value;
                const ruleId = document.getElementById("ruleId");
                const ip = document.getElementById("ip").value;
                const expireTime = document.getElementById("expireTime").value;
                const privileges = document.getElementById("privileges").value;
                // customerId = document.getElementById("customerId").value;
                // customerSecret =
                //     document.getElementById("customerSecret").value;

                if (!appid) {
                    showPopup("App ID is required");
                    return;
                }

                let baseUrl = `https://api.sd-rtn.com/dev/v1/${action}`;
                if (method === "GET") {
                    baseUrl += `?appid=${appid}`;
                }

                let payload = {};
                if (
                    method === "POST" ||
                    method === "PUT" ||
                    method === "DELETE"
                ) {
                    payload = {
                        appid,
                        cname,
                        uid: parseInt(uid),
                        ip: ip || "",
                        time: parseInt(expireTime),
                        privileges: privileges.includes("publish_audio_video")
                            ? ["publish_audio", "publish_video"]
                            : [privileges],
                    };
                    if (method === "PUT" || method === "DELETE") {
                        payload.id = parseInt(ruleId.value);
                    }
                }

                try {
                    const response = await fetch(baseUrl, {
                        method: method,
                        headers: {
                            Accept: "application/json",
                            "Content-Type": "application/json",
                            Authorization:
                                "Basic " +
                                btoa(`${customerId}:${customerSecret}`),
                        },
                        body: method !== "GET" ? JSON.stringify(payload) : null,
                    });
                    const result = await response.json();
                    document.getElementById("response").innerText =
                        JSON.stringify(result, null, 2);
                    if (method === "POST" && result.id) {
                        ruleId.value = result.id;
                        showPopup("Rule created successfully!");
                    } else if (method === "GET") {
                        showPopup("Rules retrieved successfully!");
                    } else if (method === "PUT") {
                        showPopup("Rule updated successfully!");
                    } else if (method === "DELETE") {
                        showPopup("Rule deleted successfully!");
                    }
                } catch (error) {
                    document.getElementById("response").innerText =
                        `Error: ${error.message}`;
                    showPopup(`Error: ${error.message}`);
                }
            }

            async function queryUsers() {
                const channelName =
                    document.getElementById("queryChannel").value;
                const hostOnly = document.getElementById("hostOnly").checked;
                // customerId = document.getElementById("customerId").value;
                // customerSecret =
                //     document.getElementById("customerSecret").value;
                // appid = document.getElementById("appid").value;

                if (!channelName) {
                    showPopup("Channel Name is required");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://api.agora.io/dev/v1/channel/user/${appid}/${channelName}${hostOnly ? "/hosts_only" : ""}`,
                        {
                            method: "GET",
                            headers: {
                                Accept: "application/json",
                                Authorization:
                                    "Basic " +
                                    btoa(`${customerId}:${customerSecret}`),
                            },
                        },
                    );
                    const result = await response.json();
                    document.getElementById("queryResponse").innerText =
                        JSON.stringify(result, null, 2);
                    showPopup("Users queried successfully!");
                } catch (error) {
                    document.getElementById("queryResponse").innerText =
                        `Error: ${error.message}`;
                    showPopup(`Error: ${error.message}`);
                }
            }
        </script>
        <a
        href="https://github.com/AgoraIO-Community/channel_mgmt"
        target="_blank"
        rel="noopener noreferrer"
        class="fixed top-4 right-4 w-10 h-10 modern-card flex items-center justify-center rounded-full shadow-lg hover:border-cyan-400/50 transition"
        title="View my GitHub"
        >
        <!-- Inline SVG for GitHub icon -->
        <svg
          class="w-5 h-5 text-white"
          fill="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M12 .296a12 12 0 00-3.797 23.389c.6.111.82-.261.82-.58v-2.259c-3.338.725-4.042-1.61-4.042-1.61-.547-1.39-1.336-1.76-1.336-1.76-1.09-.746.082-.73.082-.73 1.205.084 1.84 1.237 1.84 1.237 1.07 1.835 2.807 1.305 3.492.998.107-.776.42-1.305.764-1.604-2.665-.305-5.467-1.333-5.467-5.93 0-1.31.469-2.381 1.24-3.221-.125-.303-.54-1.52.117-3.165 0 0 1.012-.324 3.317 1.23.96-.267 1.987-.399 3.009-.404 1.02.005 2.049.137 3.01.404 2.304-1.554 3.315-1.23 3.315-1.23.659 1.646.244 2.863.12 3.166.772.84 1.24 1.91 1.24 3.22 0 4.61-2.807 5.623-5.48 5.92.431.372.817 1.104.817 2.224v3.293c0 .319.218.694.824.576A12 12 0 0012 .296z"
          ></path>
        </svg>
        </a>
    </body>
</html>
